#!/bin/bash

# Configuration
LOG_DIR="/var/log"
ARCHIVE_DIR="/backup/logs"
MAX_SIZE_MB=100
BACKUP_FILE="log_backup_$(date +%Y%m%d%H%M%S).tar.gz"
LOG_FILE="/var/log/log_backup_script.log"


# Ensure backup directory exists
mkdir -p "$ARCHIVE_DIR" || { echo "Error creating backup directory: $ARCHIVE_DIR" | tee -a "$LOG_FILE"; exit 1; }

# Log start of script
echo "$(date +%Y-%m-%d\ %H:%M:%S) - Backup process started." | tee -a "$LOG_FILE"

# Find and compress large log files
if find "$LOG_DIR" -type f -size +"$((MAX_SIZE_MB * 1024))"c -exec tar -czvf "$ARCHIVE_DIR/$BACKUP_FILE" {} +; then
    echo "$(date +%Y-%m-%d\ %H:%M:%S) - Backup created: $ARCHIVE_DIR/$BACKUP_FILE" | tee -a "$LOG_FILE"
else
    echo "$(date +%Y-%m-%d\ %H:%M:%S) - Error during compression." | tee -a "$LOG_FILE"
    exit 1
fi

# Remove original log files
if find "$LOG_DIR" -type f -size +"$((MAX_SIZE_MB * 1024))"c -exec rm -f {} +; then
    echo "$(date +%Y-%m-%d\ %H:%M:%S) - Original log files deleted." | tee -a "$LOG_FILE"
else
    echo "$(date +%Y-%m-%d\ %H:%M:%S) - Error removing original log files." | tee -a "$LOG_FILE"
    exit 1
fi

# Log completion
echo "$(date +%Y-%m-%d\ %H:%M:%S) - Backup process completed successfully." | tee -a "$LOG_FILE"
